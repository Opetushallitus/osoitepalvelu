git:
  depth: false
branches:
  only:
    - master
language: java
jdk:
  - openjdk11
services:
  - docker
cache:
  directories:
    - $HOME/.m2
env:
  global:
    # AWS_ACCESS_KEY_ID
    - secure: "Ubvup3FdIQFY0HG11zlPzjuJPNO3nokxUf0OJMjl9wiY2t+d2y1sAF3guXyC2xJlke6Dk+wvYy50edsgV2w7sL7ijUwJzdHfvd6wusG5m34sOq1PjfoLMZeTVlqvR1L9mZOMQbieKodvVvv55ypq5nHSmx/T2JhomF2DNYvZKCA="
    # AWS_SECRET_ACCESS_KEY
    - secure: "JDQfofuzqRowoDmBQSbKda8nxn18tDAegBWwe55x7Gu2mfHQhEbQ3alDnPq9nap/ibjYpWVFeR+i2epTCParf6kMChiAZdEYZ2eNl9+C1q/kFCNEv3R1Yvofx56YjMrUm+IlEeFdgB2JvF1Rcx4OWdQWDv7BMSxBxnxnilhhyjw="

addons:
  sonarcloud:
    organization: "opetushallitus"
    token:
      secure: "fDt22itogE3dM0s7jJORLnyRbwwOo/WHlA0NHg+WzF58y88ZjW8WrKQEvcHZYfpoH/bVouB+ebgjH3sOJ67JZDXz0YnWi6qM64jws8u8HIOzYzvAsD3AKXrbpaHSWTL006C6pBGjfF4BpKwm4cSE7oserf8bdKxl/+SmGkFjoRk="

before_install:
  - nvm install 12.18.1
  - nvm use 12.18.1

install:
  - git clone https://github.com/Opetushallitus/ci-tools.git
  - source ci-tools/common/setup-tools.sh
  - export ARTIFACT_NAME="osoitepalvelu"

script:
  - mvn clean install sonar:sonar -Dsonar.projectKey=Opetushallitus_osoitepalvelu -B -Dbranch=${TRAVIS_BRANCH} -Drevision=${TRAVIS_COMMIT} -DbuildNumber=${TRAVIS_BUILD_NUMBER}

  - mv osoitekoostepalvelu/target/osoitekoostepalvelu.war $DOCKER_BUILD_DIR/artifact/osoitekoostepalvelu.war
  - cp -vr src/main/resources/oph-configuration $DOCKER_BUILD_DIR/config/

  - export BASE_IMAGE="baseimage-war-openjdk11:master"
  - ./ci-tools/common/pull-image.sh
  - ./ci-tools/build/build-war.sh $ARTIFACT_NAME

deploy:
  - provider: script
    script: ./ci-tools/build/upload-image.sh $ARTIFACT_NAME
    on:
      all_branches: true
