git:
  depth: false
branches:
  only:
    - master
language: java
jdk:
  - openjdk11
services:
  - docker
cache:
  directories:
    - $HOME/.m2
env:
  global:
    # AWS_ACCESS_KEY_ID
    - secure: "Sj09OtFspYxXf669tIgEWB5a1BGdTtaK6ns45VQZ6MdNf+qh7wXQmmvj5U/w7kAwf3KFfBoT0cPu8hTWX/qpwcl9o9G3qFkaRF/4bwQo9fBGc4L0G87bmiSpho9YNdZFClm/I8DDeqBfbEcGYiXcXVUWPR12bWHGncD7ZHbGW+U="
    # AWS_SECRET_ACCESS_KEY
    - secure: "M95B8EHBAj+FW95BD2AUG3NdDcyElRUKCTVc57Vc98EjXACM6bjsghhTVTBPkk02KzmxaVRQmzogmbLAYANouj8I/FCXfolK2VnlDAQoguQViJ0UBnp3KAeg/3+Gq2RddHOeneFlhdTTo/R0ZbBv8sO8o1iWmjH7TyfOq7jqo3w="

addons:
  sonarcloud:
    organization: "opetushallitus"
    token:
      secure: "fDt22itogE3dM0s7jJORLnyRbwwOo/WHlA0NHg+WzF58y88ZjW8WrKQEvcHZYfpoH/bVouB+ebgjH3sOJ67JZDXz0YnWi6qM64jws8u8HIOzYzvAsD3AKXrbpaHSWTL006C6pBGjfF4BpKwm4cSE7oserf8bdKxl/+SmGkFjoRk="

before_install:
  - nvm install 12.18.1
  - nvm use 12.18.1

install:
  - git clone https://github.com/Opetushallitus/ci-tools.git
  - source ci-tools/common/setup-tools.sh
  - export ARTIFACT_NAME="osoitepalvelu"

script:
  - mvn clean install sonar:sonar -B -Dbranch=${TRAVIS_BRANCH} -Drevision=${TRAVIS_COMMIT} -DbuildNumber=${TRAVIS_BUILD_NUMBER}

  - mv osoitekoostepalvelu/target/osoitekoostepalvelu.war $DOCKER_BUILD_DIR/artifact/osoitekoostepalvelu.war
  - cp -vr src/main/resources/oph-configuration $DOCKER_BUILD_DIR/config/

  - export BASE_IMAGE="baseimage-war-openjdk11:master"
  - ./ci-tools/common/pull-image.sh
  - ./ci-tools/build/build-war.sh $ARTIFACT_NAME

deploy:
  - provider: script
    script: ./ci-tools/build/upload-image.sh $ARTIFACT_NAME
    on:
      all_branches: true
